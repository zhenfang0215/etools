<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡Œé¢å®šæ—¶å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSS å˜é‡å®šä¹‰ - æ·±è‰²ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰ */
        :root {
            --bg-primary: #2c2c2c;
            --bg-secondary: #3c3c3c;
            --bg-hover: #454545;
            --bg-active: #4a4a4a;
            --bg-selected: #3a9cb8;
            --border-color: #4a4a4a;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
        }

        /* æµ…è‰²ä¸»é¢˜ */
        body.light-theme {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-hover: #e8e8e8;
            --bg-active: #d8d8d8;
            --bg-selected: #8e44ad;
            --border-color: #e0e0e0;
            --text-primary: #2c2c2c;
            --text-secondary: #666666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            overflow: hidden;
            user-select: none;
            margin: 0;
            padding: 0;
            min-height: 0;
            transition: background-color 0.15s ease;
        }
        
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 0;
            min-height: 0;
            display: block;
        }

        /* åˆ—è¡¨å®¹å™¨ */
        .list-container {
            background: transparent;
            padding: 0;
            margin: 0;
            overflow: visible;
            min-height: 0;
        }

        .list-container::-webkit-scrollbar {
            width: 0px;
            display: none;
        }

        /* åˆ—è¡¨é¡¹ */
        .list-item {
            background: var(--bg-secondary);
            margin: 0;
            padding: 8px 14px; /* é«˜åº¦-é—´è·æ•´ä½“å‹ç¼© */
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.08s ease, color 0.08s ease; /* åªå¯¹é¢œè‰²åšè¿‡æ¸¡ï¼ŒåŠ å¿«é€Ÿåº¦ */
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 40px; /* æ§åˆ¶æœ€å°é«˜åº¦ï¼Œé¿å…è¿‡å° */
        }
        
        .list-item:first-child {
            border-top: none;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }

        /* åªæœ‰åœ¨éé”®ç›˜å¯¼èˆªæ¨¡å¼ä¸‹ä¸”æœªè¢«é€‰ä¸­æ—¶æ‰æ˜¾ç¤ºhoveræ•ˆæœ */
        body:not(.keyboard-nav) .list-item:hover:not(.selected) {
            background: var(--bg-hover);
        }

        .list-item:active {
            background: var(--bg-active);
        }

        .list-item.selected {
            background: var(--bg-selected);
            color: white;
        }

        .list-item.selected .list-item-title,
        .list-item.selected .list-item-description {
            color: white !important;
        }

        .list-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: transparent;
            color: white;
            flex-shrink: 0;
        }

        .list-item-icon img {
            width: 36px;
            height: 36px;
            object-fit: cover;
            border-radius: 10px;
        }

        .list-item-content {
            flex: 1;
            min-width: 0;
        }

        .list-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .list-item-description {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ä»…æ ‡é¢˜çš„é¡¹ï¼šæ”¾å¤§æ ‡é¢˜å­—å·å¹¶å‚ç›´å±…ä¸­å æ»¡ç©ºé—´ */
        .list-item.no-desc .list-item-title {
            font-size: 16px;
            line-height: 1.25;
            margin-bottom: 0;
        }
        .list-item.no-desc .list-item-content {
            display: flex;
            align-items: center;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .empty-state-description {
            font-size: 13px;
            opacity: 0.7;
            color: var(--text-secondary);
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }


        /* ç‰¹æ®Šç±»å‹çš„åˆ—è¡¨é¡¹æ ·å¼ */
        .list-item.back-item {
            background: var(--bg-secondary);
        }

        /* åªæœ‰åœ¨éé”®ç›˜å¯¼èˆªæ¨¡å¼ä¸‹ä¸”æœªè¢«é€‰ä¸­æ—¶æ‰æ˜¾ç¤ºhoveræ•ˆæœ */
        body:not(.keyboard-nav) .list-item.back-item:hover:not(.selected) {
            background: var(--bg-hover);
        }

        .list-item.back-item.selected {
            background: var(--bg-selected) !important;
        }

        /* è®¾ç½®é¡µé¢æ ·å¼ */
        .settings-page {
            display: none; /* é»˜è®¤éšè— */
            height: 100vh;
            background: var(--bg-primary);
        }

        .settings-page.active {
            display: flex;
        }

        .settings-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .settings-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.08s ease;
        }

        body:not(.keyboard-nav) .settings-item:hover:not(.active) {
            background: var(--bg-hover);
        }

        .settings-item.active {
            background: var(--bg-selected);
            color: white;
        }

        .settings-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-item.active .settings-item-title {
            color: white;
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .settings-description {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-option-label {
            flex: 1;
        }

        .settings-option-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .settings-option-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .settings-option-control {
            margin-left: 20px;
        }

        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.2s;
            border-radius: 24px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.2s;
            border-radius: 50%;
        }

        .switch input:checked + .switch-slider {
            background-color: var(--bg-selected);
        }

        .switch input:checked + .switch-slider:before {
            transform: translateX(20px);
        }

        /* ä¸‹æ‹‰é€‰æ‹©æ¡† */
        .settings-select {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .settings-select:hover {
            border-color: var(--bg-selected);
        }

        .settings-select:focus {
            border-color: var(--bg-selected);
            box-shadow: 0 0 0 2px rgba(124, 77, 255, 0.2);
        }

        .settings-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* è¿”å›æŒ‰é’® */
        .settings-back {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.08s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-back:hover {
            background: var(--bg-hover);
        }

        .settings-back-icon {
            font-size: 16px;
        }

        .settings-back-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* ç©ºçŠ¶æ€ */
        .settings-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .settings-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .settings-empty-text {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div id="listContainer" class="list-container">
            <!-- åˆ—è¡¨é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- è®¾ç½®é¡µé¢ -->
        <div id="settingsPage" class="settings-page">
            <div class="settings-sidebar">
                <div class="settings-back" id="settingsBack">
                    <span class="settings-back-icon">â†</span>
                    <span class="settings-back-text">è¿”å›</span>
                </div>
                <div id="settingsSidebar">
                    <!-- è®¾ç½®é¡¹åˆ—è¡¨ -->
                </div>
            </div>
            <div class="settings-content">
                <div id="settingsContent">
                    <!-- è®¾ç½®è¯¦æƒ… -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å›½é™…åŒ–ï¼ˆi18nï¼‰ç³»ç»Ÿ ====================
        
        // ä» preload ä¸­è·å– i18n é…ç½®ï¼ˆå·²åœ¨ main-preload.js ä¸­æ³¨å…¥ï¼‰
        const i18nMessages = window.i18nMessages;
        const supportedLanguages = window.supportedLanguages;
        
        // å½“å‰è¯­è¨€
        let currentLanguage = 'en';
        
        // è·å–ä¿å­˜çš„è¯­è¨€è®¾ç½®
        function getSavedLanguage() {
            return utools.dbStorage.getItem('language') || 'en';
        }
        
        // ä¿å­˜è¯­è¨€è®¾ç½®
        function saveLanguage(lang) {
            currentLanguage = lang;
            utools.dbStorage.setItem('language', lang);
            // é‡æ–°åˆå§‹åŒ–ç•Œé¢
            if (isInSettingsPage) {
                // æ›´æ–° Back æŒ‰é’®æ–‡æœ¬
                const backText = settingsBack.querySelector('.settings-back-text');
                if (backText) {
                    backText.textContent = t('settingsBack');
                }
                // é‡æ–°æ¸²æŸ“è®¾ç½®é¡µé¢å†…å®¹
                renderSettingsSidebar();
                if (currentSettingsCategory) {
                    showSettingsCategory(currentSettingsCategory);
                }
            } else {
                updateList(currentSearchTerm);
            }
        }
        
        // ç¿»è¯‘å‡½æ•°
        function t(key, ...args) {
            const messages = i18nMessages[currentLanguage] || i18nMessages['en'];
            let text = messages[key] || key;
            
            // æ”¯æŒå ä½ç¬¦æ›¿æ¢ {0}, {1}, ...
            args.forEach((arg, index) => {
                text = text.replace(`{${index}}`, arg);
            });
            
            return text;
        }
        
        // ç¿»è¯‘åˆ—è¡¨é¡¹æ–‡æœ¬ï¼ˆä»è‹±æ–‡åˆ°å½“å‰è¯­è¨€ï¼‰
        function translateItem(item) {
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ custom ç±»å‹ä¸”æè¿°ä¸ºç©ºï¼Œä½¿ç”¨ customHint
            if (item.type === 'custom' && (!item.description || item.description === '')) {
                return {
                    ...item,
                    description: t('customHint')
                };
            }
            
            if (currentLanguage === 'en') return item;
            
            // æ ‡é¢˜ç¿»è¯‘æ˜ å°„
            const titleMap = {
                'Pomodoro': t('pomodoro'),
                'Short Break': t('shortBreak'),
                'Set timer for 5 minutes': t('shortBreak'),
                'Long Break': t('longBreak'),
                'Set timer for 10 minutes': t('longBreak'),
                'Custom': t('custom'),
                'Set timer': t('custom'),
                'Show activity timers': t('history'),
                'Activity Timers': t('history'),
                'Settings': t('settings'),
                'Start': t('startTask'),
                'Cancel': t('cancelTask'),
                'Cancel timer': t('cancelTimer'),
                'Modify Time': t('modifyTime'),
                'Set new time': t('setNewTime'),
                'Back to Tasks': t('backToTasks'),
                'Back to Main': t('backToMain'),
                'No running timers': t('noRunningTasks'),
                'No active timers. Create new one?': t('noActiveTimers'),
                'Failed to get current tasks': t('getTasksFailed'),
                'Not started': t('notStarted'),
                'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å®šæ—¶å™¨': t('noResults'),
                'å°šæœªå¼€å§‹': t('notStarted'),
                'æš‚æ— æ´»åŠ¨å®šæ—¶å™¨ï¼Œåˆ›å»ºæ–°çš„ï¼Ÿ': t('noActiveTimers'),
                'è·å–å½“å‰ä»»åŠ¡å¤±è´¥': t('getTasksFailed'),
                'å–æ¶ˆå®šæ—¶å™¨': t('cancelTimer'),
                'è®¾ç½®æ–°æ—¶é—´': t('setNewTime'),
            };
            
            // æè¿°ç¿»è¯‘æ˜ å°„
            const descMap = {
                'Standard 25-minute work timer': t('pomodoroDesc'),
                'Quick 5-minute rest': t('shortBreakDesc'),
                '15-minute relaxation time': t('longBreakDesc'),
                'Enter custom time': t('customDesc'),
                'Hit â†©ï¸ to set to 1 minute or provide duration': t('customHint'),
                'View all running timers': t('historyDesc'),
                'é…ç½®å®šæ—¶å™¨è®¾ç½®': t('settingsDesc'),
                'Configure app preferences': t('settingsDesc'),
                'Start a timer to see it here': t('noRunningTasksDesc'),
                'Return to task list': t('backToTasksList'),
                'Cannot read running tasks': t('cannotReadTasks'),
                'No description': t('noDescription'),
                'è¯·å°è¯•å…¶ä»–å…³é”®è¯ï¼Œå¦‚ï¼šä¼‘æ¯ã€25åˆ†é’Ÿã€è‡ªå®šä¹‰ç­‰': t('noResultsDesc'),
                'Try different keywords': t('noResultsDesc'),
                'æ— æ³•è¯»å–å½“å‰è¿è¡Œä¸­çš„ä»»åŠ¡': t('cannotReadTasks'),
                'æ— æè¿°ä¿¡æ¯': t('noDescription'),
                'è¿”å›ä»»åŠ¡åˆ—è¡¨': t('backToTasksList'),
            };
            
            // å¤„ç†åŠ¨æ€ç”Ÿæˆçš„æ–‡æœ¬ï¼ˆå¦‚ "Will fire at 14:30"ï¼‰
            let translatedTitle = titleMap[item.title] || item.title;
            let translatedDesc = descMap[item.description] || item.description;
            
            // ç¿»è¯‘åŒ…å« "Timer" çš„æ ‡é¢˜ï¼ˆå¦‚ "Timer 25 åˆ†é’Ÿ"ï¼‰
            if (item.title && item.title.startsWith('Timer ') || item.title.startsWith('å®šæ—¶å™¨ ')) {
                // ä¿æŒåŸæ ·ï¼Œå› ä¸ºè¿™æ˜¯ä» index.js åŠ¨æ€ç”Ÿæˆçš„ï¼Œå·²ç»ç¿»è¯‘è¿‡äº†
            }
            
            // ç¿»è¯‘ "Will fire at" æè¿°
            if (item.description && (item.description.startsWith('Will fire at') || item.description.startsWith('å°†äº'))) {
                // ä¿æŒåŸæ ·ï¼Œå› ä¸ºè¿™æ˜¯ä» index.js åŠ¨æ€ç”Ÿæˆçš„ï¼Œå·²ç»ç¿»è¯‘è¿‡äº†
            }
            
            return {
                ...item,
                title: translatedTitle,
                description: translatedDesc
            };
        }
        
        
        // ==================== ä¸»åº”ç”¨ä»£ç  ====================
        
        // å¯¼å…¥ä¸šåŠ¡é€»è¾‘ï¼ˆåœ¨ preload ä¸­å·²ç»æ³¨å…¥ï¼‰
        const TimerBusiness = window.TimerBusinessLogic;
        
        // DOM å…ƒç´ 
        const listContainer = document.getElementById('listContainer');
        const settingsPage = document.getElementById('settingsPage');
        const settingsSidebar = document.getElementById('settingsSidebar');
        const settingsContent = document.getElementById('settingsContent');
        const settingsBack = document.getElementById('settingsBack');

        // å½“å‰çŠ¶æ€
        let currentSearchTerm = '';
        let selectedIndex = 0; // å½“å‰é€‰ä¸­çš„åˆ—è¡¨é¡¹ç´¢å¼•
        let isInSubView = false; // ğŸ”¥ æ˜¯å¦åœ¨å­è§†å›¾ä¸­ï¼ˆå¦‚ä»»åŠ¡åˆ—è¡¨ã€æ“ä½œèœå•ç­‰ï¼‰
        let isUsingKeyboard = false; // ğŸ”¥ æ˜¯å¦æ­£åœ¨ä½¿ç”¨é”®ç›˜å¯¼èˆª
        let isInSettingsPage = false; // æ˜¯å¦åœ¨è®¾ç½®é¡µé¢
        let currentSettingsCategory = null; // å½“å‰é€‰ä¸­çš„è®¾ç½®åˆ†ç±»
        let selectedSettingsIndex = 0; // å½“å‰é€‰ä¸­çš„è®¾ç½®åˆ†ç±»ç´¢å¼•
        
        // é¼ æ ‡ä½ç½®è¿½è¸ªï¼ˆç”¨äºé˜²æ­¢è¿›å…¥æ—¶è¯¯è§¦ï¼‰
        let lastMouseX = null;
        let lastMouseY = null;

        // è·å–ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
        function getSavedTheme() {
            return utools.dbStorage.getItem('theme') || 'system';
        }
        
        // ä¿å­˜ä¸»é¢˜è®¾ç½®
        function saveTheme(theme) {
            utools.dbStorage.setItem('theme', theme);
            applyTheme();
        }
        
        // åº”ç”¨ä¸»é¢˜
        function applyTheme() {
            const savedTheme = getSavedTheme();
            
            if (savedTheme === 'dark') {
                // å¼ºåˆ¶æ·±è‰²ä¸»é¢˜
                document.body.classList.remove('light-theme');
            } else if (savedTheme === 'light') {
                // å¼ºåˆ¶æµ…è‰²ä¸»é¢˜
                document.body.classList.add('light-theme');
            } else {
                // è·Ÿéšç³»ç»Ÿ
                const isDark = utools.isDarkColors();
                if (isDark) {
                    document.body.classList.remove('light-theme');
                } else {
                    document.body.classList.add('light-theme');
                }
            }
        }

        // è·å–è®¾ç½®æ•°æ®ï¼ˆåŠ¨æ€ç”Ÿæˆä»¥æ”¯æŒ i18nï¼‰
        function getSettingsData() {
            return [
                {
                    id: 'appearance',
                    title: t('appearanceSettings'),
                    description: t('appearanceDesc'),
                    options: [
                        { 
                            id: 'theme', 
                            title: t('theme'), 
                            description: t('themeDesc'), 
                            type: 'select',
                            value: 'system',
                            options: [
                                { value: 'system', label: t('themeSystem') },
                                { value: 'dark', label: t('themeDark') },
                                { value: 'light', label: t('themeLight') }
                            ]
                        },
                        { 
                            id: 'language', 
                            title: t('language'), 
                            description: t('languageDesc'), 
                            type: 'select',
                            value: 'en',
                            options: supportedLanguages
                        }
                    ]
                }
            ];
        }

        // æ˜¾ç¤ºè®¾ç½®é¡µé¢
        function showSettingsPage() {
            isInSettingsPage = true;
            listContainer.style.display = 'none';
            settingsPage.classList.add('active');
            
            // ğŸ”¥ åˆå§‹åŒ–è®¾ç½®é¡µé¢çš„é”®ç›˜å¯¼èˆª
            selectedSettingsIndex = 0;
            isUsingKeyboard = true;
            document.body.classList.add('keyboard-nav');
            lastMouseX = null;
            lastMouseY = null;
            
            // æ›´æ–°è¿”å›æŒ‰é’®æ–‡æœ¬
            const backText = settingsBack.querySelector('.settings-back-text');
            if (backText) {
                backText.textContent = t('settingsBack');
            }
            
            // æ¸²æŸ“è®¾ç½®ä¾§è¾¹æ 
            renderSettingsSidebar();
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªåˆ†ç±»
            const settingsData = getSettingsData();
            if (settingsData.length > 0) {
                showSettingsCategory(settingsData[0].id);
            }
            
            // è°ƒæ•´çª—å£é«˜åº¦ä¸ºå›ºå®šé«˜åº¦
            utools.setExpendHeight(500);
            
            // æ›´æ–°è¾“å…¥æ¡†æç¤º
            utools.setSubInput(({ text }) => {
                currentSearchTerm = text;
                searchSettings(text);
            }, t('settingsSearch'), true);
        }

        // éšè—è®¾ç½®é¡µé¢ï¼Œè¿”å›ä¸»åˆ—è¡¨
        function hideSettingsPage() {
            isInSettingsPage = false;
            settingsPage.classList.remove('active');
            listContainer.style.display = 'block';
            currentSearchTerm = '';
            
            // ğŸ”¥ é‡ç½®é«˜åº¦å˜é‡ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—é«˜åº¦
            lastHeight = 0;
            lastItemCount = 0;
            
            // ğŸ”¥ é‡ç½®é¼ æ ‡ä½ç½®ï¼Œé˜²æ­¢ç«‹å³è§¦å‘é¼ æ ‡é€‰æ‹©
            isUsingKeyboard = true;
            document.body.classList.add('keyboard-nav');
            lastMouseX = null;
            lastMouseY = null;
            
            // æ¢å¤ä¸»åˆ—è¡¨
            utools.setSubInput(({ text }) => {
                currentSearchTerm = text;
                handleSearch(text);
            }, t('inputPlaceholder'), true);
            
            updateList('');
        }

        // æ¸²æŸ“è®¾ç½®ä¾§è¾¹æ 
        function renderSettingsSidebar(filteredData = null) {
            if (!filteredData) {
                filteredData = getSettingsData();
            }
            settingsSidebar.innerHTML = filteredData.map((category, index) => `
                <div class="settings-item ${index === selectedSettingsIndex ? 'active' : ''}" 
                     data-category="${category.id}"
                     data-index="${index}">
                    <div class="settings-item-title">${category.title}</div>
                </div>
            `).join('');
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶å’Œé¼ æ ‡æ‚¬åœäº‹ä»¶
            settingsSidebar.querySelectorAll('.settings-item').forEach((elem, index) => {
                elem.addEventListener('click', () => {
                    const categoryId = elem.dataset.category;
                    selectedSettingsIndex = index;
                    showSettingsCategory(categoryId);
                });
                
                // é¼ æ ‡æ‚¬åœæ—¶æ›´æ–°é€‰ä¸­ç´¢å¼•ï¼ˆä½†å¦‚æœæ­£åœ¨ä½¿ç”¨é”®ç›˜åˆ™å¿½ç•¥ï¼‰
                elem.addEventListener('mouseenter', () => {
                    if (!isUsingKeyboard) {
                        selectedSettingsIndex = index;
                        updateSelectedSettingsItem();
                    }
                });
            });
        }

        // æ˜¾ç¤ºè®¾ç½®åˆ†ç±»è¯¦æƒ…
        function showSettingsCategory(categoryId) {
            currentSettingsCategory = categoryId;
            const settingsData = getSettingsData();
            const category = settingsData.find(c => c.id === categoryId);
            
            if (!category) return;
            
            // æ›´æ–°ä¾§è¾¹æ é€‰ä¸­çŠ¶æ€
            settingsSidebar.querySelectorAll('.settings-item').forEach(elem => {
                if (elem.dataset.category === categoryId) {
                    elem.classList.add('active');
                } else {
                    elem.classList.remove('active');
                }
            });
            
            // æ¸²æŸ“è¯¦æƒ…å†…å®¹
            settingsContent.innerHTML = `
                <div class="settings-header">
                    <div class="settings-title">${category.title}</div>
                    <div class="settings-description">${category.description || ''}</div>
                </div>
                ${category.options.map(option => {
                    // è·å–å½“å‰ä¿å­˜çš„å€¼
                    let currentValue = option.value;
                    if (option.id === 'theme') {
                        currentValue = getSavedTheme();
                    } else if (option.id === 'language') {
                        currentValue = getSavedLanguage();
                    }
                    
                    return `
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <div class="settings-option-title">${option.title}</div>
                            <div class="settings-option-desc">${option.description}</div>
                        </div>
                        <div class="settings-option-control">
                            ${option.type === 'select' ? `
                                <select class="settings-select" data-option="${option.id}">
                                    ${option.options.map(opt => `
                                        <option value="${opt.value}" ${currentValue === opt.value ? 'selected' : ''}>
                                            ${opt.label}
                                        </option>
                                    `).join('')}
                                </select>
                            ` : option.type === 'switch' ? `
                                <label class="switch">
                                    <input type="checkbox" ${currentValue ? 'checked' : ''} 
                                           data-option="${option.id}">
                                    <span class="switch-slider"></span>
                                </label>
                            ` : option.type === 'button' ? `
                                <button class="settings-button" data-action="${option.action}">
                                    æ‰§è¡Œ
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    `;
                }).join('')}
            `;
            
            // æ·»åŠ ä¸‹æ‹‰é€‰æ‹©æ¡†äº‹ä»¶ç›‘å¬
            settingsContent.querySelectorAll('.settings-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const optionId = e.target.dataset.option;
                    const value = e.target.value;
                    
                    if (optionId === 'theme') {
                        saveTheme(value);
                    } else if (optionId === 'language') {
                        saveLanguage(value);
                    }
                });
            });
            
            // æ·»åŠ å¼€å…³äº‹ä»¶ç›‘å¬
            settingsContent.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const optionId = e.target.dataset.option;
                    console.log(`è®¾ç½® ${optionId} å·²${e.target.checked ? 'å¼€å¯' : 'å…³é—­'}`);
                });
            });
        }

        // æœç´¢è®¾ç½®é¡¹
        function searchSettings(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                renderSettingsSidebar();
                if (currentSettingsCategory) {
                    showSettingsCategory(currentSettingsCategory);
                }
                return;
            }
            
            const term = searchTerm.toLowerCase().trim();
            const settingsData = getSettingsData();
            
            // è¿‡æ»¤è®¾ç½®åˆ†ç±»å’Œé€‰é¡¹
            const filteredData = settingsData.map(category => {
                const matchingOptions = category.options.filter(option => 
                    option.title.toLowerCase().includes(term) ||
                    option.description.toLowerCase().includes(term)
                );
                
                return {
                    ...category,
                    options: matchingOptions
                };
            }).filter(category => 
                category.title.toLowerCase().includes(term) ||
                category.options.length > 0
            );
            
            if (filteredData.length === 0) {
                const noResultsText = t('noSettingsFound');
                settingsSidebar.innerHTML = `<div class="settings-empty"><div class="settings-empty-icon">ğŸ”</div><div class="settings-empty-text">${noResultsText}</div></div>`;
                settingsContent.innerHTML = `<div class="settings-empty"><div class="settings-empty-icon">ğŸ”</div><div class="settings-empty-text">${noResultsText}</div></div>`;
            } else {
                renderSettingsSidebar(filteredData);
                // è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ†ç±»
                if (filteredData.length > 0) {
                    showSettingsCategory(filteredData[0].id);
                }
            }
        }

        // åˆå§‹åŒ–ï¼ˆåœ¨æ’ä»¶è¿›å…¥æ—¶è°ƒç”¨ï¼‰
        function initialize() {
            // ğŸŒ åŠ è½½ä¿å­˜çš„è¯­è¨€
            currentLanguage = getSavedLanguage();
            
            // ğŸ¨ åº”ç”¨ä¸»é¢˜
            applyTheme();
            
            // ğŸ”¥ è¿›å…¥æ’ä»¶æ—¶ç¦ç”¨é¼ æ ‡é€‰æ‹©ï¼Œé¿å…é¼ æ ‡æ­£å¥½åœ¨æŸä¸ªitemä¸Šæ—¶ç«‹å³è¢«é€‰ä¸­
            isUsingKeyboard = true;
            document.body.classList.add('keyboard-nav');
            lastMouseX = null;
            lastMouseY = null;
            
            // ğŸ”¥ å…ˆè®¾ç½®ä¸€ä¸ªåˆå§‹é¢„ä¼°é«˜åº¦ï¼ˆ4ä¸ªé¡¹ç›®ï¼‰
            utools.setExpendHeight(estimateHeight(4));
            
            // æ‰§è¡Œæ•°æ®åº“ç»´æŠ¤
            TimerBusiness.initializeDatabaseMaintenance();
            
            // æ£€æŸ¥è¿‡æœŸçš„å®šæ—¶å™¨
            TimerBusiness.checkExpiredTimers();
            
            // é‡ç½®çŠ¶æ€
            TimerBusiness.setCurrentState('normal');
            currentSearchTerm = '';
            lastHeight = 0; // é‡ç½®ä¸Šæ¬¡é«˜åº¦
            isInSubView = false; // ğŸ”¥ é‡ç½®å­è§†å›¾çŠ¶æ€
            
            // ç¡®ä¿è®¾ç½®é¡µé¢å·²éšè—
            if (isInSettingsPage) {
                settingsPage.classList.remove('active');
                listContainer.style.display = 'block';
                isInSettingsPage = false;
            }
            
            // æ˜¾ç¤ºåˆå§‹åˆ—è¡¨
            updateList('');
            
            // å¯åŠ¨å®æ—¶æ›´æ–°
            TimerBusiness.startRealTimeUpdate();
            
            // ğŸ”¥ ä½¿ç”¨ uTools ä¸»è¾“å…¥æ¡†ï¼ˆæ¯æ¬¡è¿›å…¥æ—¶éƒ½è¦è®¾ç½®ï¼‰
            utools.setSubInput(({ text }) => {
                currentSearchTerm = text;
                handleSearch(text);
            }, t('inputPlaceholder'), true);
        }
        
        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyDown(e) {
            // å¦‚æœåœ¨è®¾ç½®é¡µé¢ï¼Œä½¿ç”¨è®¾ç½®é¡µé¢çš„é”®ç›˜å¯¼èˆª
            if (isInSettingsPage) {
                handleSettingsKeyDown(e);
                return;
            }
            
            // ä¸»åˆ—è¡¨çš„é”®ç›˜å¯¼èˆª
            const items = window.currentListItems;
            if (!items || items.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                isUsingKeyboard = true; // æ ‡è®°æ­£åœ¨ä½¿ç”¨é”®ç›˜
                document.body.classList.add('keyboard-nav'); // æ·»åŠ é”®ç›˜å¯¼èˆªç±»
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelectedItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                isUsingKeyboard = true; // æ ‡è®°æ­£åœ¨ä½¿ç”¨é”®ç›˜
                document.body.classList.add('keyboard-nav'); // æ·»åŠ é”®ç›˜å¯¼èˆªç±»
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelectedItem();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (items[selectedIndex]) {
                    handleItemClick(items[selectedIndex]);
                }
            }
        }
        
        // è®¾ç½®é¡µé¢çš„é”®ç›˜å¯¼èˆª
        function handleSettingsKeyDown(e) {
            const settingsData = getSettingsData();
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                isUsingKeyboard = true;
                document.body.classList.add('keyboard-nav');
                selectedSettingsIndex = (selectedSettingsIndex + 1) % settingsData.length;
                updateSelectedSettingsItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                isUsingKeyboard = true;
                document.body.classList.add('keyboard-nav');
                selectedSettingsIndex = (selectedSettingsIndex - 1 + settingsData.length) % settingsData.length;
                updateSelectedSettingsItem();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                // å±•å¼€å½“å‰é€‰ä¸­çš„è®¾ç½®åˆ†ç±»
                showSettingsCategory(settingsData[selectedSettingsIndex].id);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                // ESC é”®è¿”å›ä¸»åˆ—è¡¨
                hideSettingsPage();
            }
        }
        
        // æ›´æ–°è®¾ç½®é¡µé¢é€‰ä¸­é¡¹çš„æ˜¾ç¤º
        function updateSelectedSettingsItem() {
            const settingsItems = settingsSidebar.querySelectorAll('.settings-item');
            let selectedCategoryId = null;
            
            settingsItems.forEach((elem, index) => {
                if (index === selectedSettingsIndex) {
                    elem.classList.add('active');
                    // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                    elem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    selectedCategoryId = elem.dataset.category;
                } else {
                    elem.classList.remove('active');
                }
            });
            
            // æ›´æ–°è¯¦æƒ…å†…å®¹
            if (selectedCategoryId) {
                showSettingsCategory(selectedCategoryId);
            }
        }
        
        // æ›´æ–°é€‰ä¸­é¡¹çš„æ˜¾ç¤º
        function updateSelectedItem() {
            const listItems = listContainer.querySelectorAll('.list-item');
            listItems.forEach((elem, index) => {
                if (index === selectedIndex) {
                    elem.classList.add('selected');
                    // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                    elem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    elem.classList.remove('selected');
                }
            });
        }

        // æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
        function updateList(searchTerm) {
            TimerBusiness.setCurrentSearchTerm(searchTerm);
            
            const currentState = TimerBusiness.getCurrentState();
            const items = TimerBusiness.generateListItemsWithDynamicTime(searchTerm);
            
            // æ¸²æŸ“åˆ—è¡¨
            renderList(items);
        }

        // å¿«é€Ÿé¢„ä¼°é«˜åº¦ï¼ˆåœ¨æ¸²æŸ“å‰ï¼‰
        function estimateHeight(itemCount) {
            const itemHeight = 48; // ğŸ”¥ ç¨å¾®å¢åŠ é¢„ä¼°é«˜åº¦ï¼ˆ44 + è¾¹è·/è¾¹æ¡†ï¼‰
            const estimated = itemCount * itemHeight + 30; // ğŸ”¥ é¢å¤–å¢åŠ  30px å®¹é”™
            return Math.min(estimated, 500);
        }
        
        // ä¸Šæ¬¡çš„åˆ—è¡¨é¡¹æ•°é‡
        let lastItemCount = 0;
        
        // æ¸²æŸ“åˆ—è¡¨
        function renderList(items, keepSelection = false) {
            // ğŸŒ ç¿»è¯‘åˆ—è¡¨é¡¹
            if (items && items.length > 0) {
                items = items.map(item => translateItem(item));
            }
            
            if (!items || items.length === 0) {
                // ğŸ”¥ å…ˆå¿«é€Ÿè®¾ç½®é¢„ä¼°é«˜åº¦
                utools.setExpendHeight(estimateHeight(0) || 150);
                
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">â°</div>
                        <div class="empty-state-title">${t('noResults')}</div>
                        <div class="empty-state-description">${t('noResultsDesc')}</div>
                    </div>
                `;
                selectedIndex = 0;
                lastItemCount = 0;
                adjustWindowHeight();
                return;
            }

            // ğŸ”¥ åªæœ‰åˆ—è¡¨é¡¹æ•°é‡å˜åŒ–æ—¶æ‰é¢„ä¼°é«˜åº¦
            if (items.length !== lastItemCount) {
                utools.setExpendHeight(estimateHeight(items.length));
                lastItemCount = items.length;
            }
            
            // ğŸ”¥ ä¿æŒå½“å‰é€‰ä¸­çš„ç´¢å¼•ï¼ˆåˆ·æ–°æ—¶ä¸é‡ç½®ï¼‰
            if (!keepSelection) {
                selectedIndex = 0;
            } else {
                // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
                selectedIndex = Math.min(selectedIndex, items.length - 1);
            }

            listContainer.innerHTML = items.map((item, index) => {
                const icon = getIconContent(item.icon, item.type);
                const itemClass = getItemClass(item.type);
                const selectedClass = index === selectedIndex ? 'selected' : '';
                const descClass = item.description ? 'has-desc' : 'no-desc';
                
                return `
                    <div class="list-item ${itemClass} ${selectedClass} ${descClass}" data-index="${index}">
                        <div class="list-item-icon">${icon}</div>
                        <div class="list-item-content">
                            <div class="list-item-title">${escapeHtml(item.title)}</div>
                            ${item.description ? `<div class="list-item-description">${escapeHtml(item.description)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶å’Œé¼ æ ‡æ‚¬åœäº‹ä»¶
            const listItems = listContainer.querySelectorAll('.list-item');
            listItems.forEach((elem, index) => {
                elem.addEventListener('click', () => handleItemClick(items[index]));
                // é¼ æ ‡æ‚¬åœæ—¶æ›´æ–°é€‰ä¸­ç´¢å¼•ï¼ˆä½†å¦‚æœæ­£åœ¨ä½¿ç”¨é”®ç›˜åˆ™å¿½ç•¥ï¼‰
                elem.addEventListener('mouseenter', () => {
                    if (!isUsingKeyboard) {
                        selectedIndex = index;
                        updateSelectedItem();
                    }
                });
            });

            // ä¿å­˜å½“å‰åˆ—è¡¨é¡¹ä¾›é”®ç›˜æ“ä½œä½¿ç”¨
            window.currentListItems = items;
            
            // ğŸ”¥ åªæœ‰åˆ—è¡¨é¡¹æ•°é‡å˜åŒ–æ—¶æ‰è°ƒæ•´çª—å£é«˜åº¦
            if (items.length !== lastItemCount || !keepSelection) {
                adjustWindowHeight();
            }
        }
        
        // é˜²æŠ–å®šæ—¶å™¨
        let heightAdjustTimer = null;
        let lastHeight = 0;
        
        // åŠ¨æ€è°ƒæ•´çª—å£é«˜åº¦ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function adjustWindowHeight() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (heightAdjustTimer) {
                clearTimeout(heightAdjustTimer);
            }
            
            // ç«‹å³è®¡ç®—é«˜åº¦ï¼ˆä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM å·²æ›´æ–°ï¼‰
            requestAnimationFrame(() => {
                let totalHeight = 0;
                
                // ğŸ”¥ ä½¿ç”¨ scrollHeight è·å–å†…å®¹é«˜åº¦ï¼ˆæœ€å¿«æœ€å‡†ç¡®ï¼‰
                totalHeight = listContainer.scrollHeight;
                
                // å¦‚æœ scrollHeight ä¸º 0ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                if (totalHeight === 0) {
                    const rect = listContainer.getBoundingClientRect();
                    totalHeight = rect.height;
                }
                
                // å¦‚æœè¿˜æ˜¯ 0ï¼Œæ‰‹åŠ¨è®¡ç®—
                if (totalHeight === 0) {
                    const listItems = listContainer.querySelectorAll('.list-item');
                    listItems.forEach(item => {
                        totalHeight += item.offsetHeight;
                    });
                    
                    // å¦‚æœæ²¡æœ‰åˆ—è¡¨é¡¹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç©ºçŠ¶æ€
                    if (listItems.length === 0) {
                        const emptyState = listContainer.querySelector('.empty-state');
                        if (emptyState) {
                            totalHeight += emptyState.offsetHeight;
                        }
                    }
                }
                
                // è®¾ç½®æœ€å¤§é«˜åº¦ 500pxï¼ˆä¸è®¾æœ€å°é«˜åº¦ï¼Œè®©å®ƒè‡ªé€‚åº”ï¼‰
                const finalHeight = Math.min(totalHeight, 500);
                
                // åªæœ‰å½“é«˜åº¦çœŸæ­£å˜åŒ–æ—¶æ‰è°ƒæ•´
                if (finalHeight !== lastHeight) {
                    utools.setExpendHeight(finalHeight);
                    lastHeight = finalHeight;
                }
            });
        }

        // è·å–å›¾æ ‡å†…å®¹
        function getIconContent(iconPath, type) {
            // å¦‚æœæ˜¯å›¾ç‰‡è·¯å¾„ï¼Œä½¿ç”¨ img æ ‡ç­¾
            if (iconPath && iconPath.startsWith('./icons/')) {
                return `<img src="${iconPath}" alt="icon">`;
            }
            
            // å¦åˆ™ä½¿ç”¨ emoji å›¾æ ‡
            const iconMap = {
                'history': 'ğŸ“‹',
                'shortBreak': 'â˜•',
                'longBreak': 'ğŸ›‹ï¸',
                'custom': 'âš™ï¸',
                'custom_time': 'â±ï¸',
                'current_task_item': 'â–¶ï¸',
                'modify_time': 'âœï¸',
                'cancel_task': 'âŒ',
                'back_to_tasks': 'â—€ï¸',
                'back_to_main': 'â—€ï¸',
                'ready_to_start': 'âœ…',
                'ready_to_modify': 'âœ…',
                'message_input_waiting': 'ğŸ’¬',
                'modify_time_input': 'âœï¸',
                'custom_input_hint': 'âš™ï¸',
                'settings': 'âš™ï¸'
            };
            
            return iconMap[type] || 'â°';
        }

        // è·å–åˆ—è¡¨é¡¹æ ·å¼ç±»
        function getItemClass(type) {
            if (type && (type.includes('back') || type === 'back_to_tasks' || type === 'back_to_main')) {
                return 'back-item';
            }
            if (type === 'ready_to_start' || type === 'ready_to_modify') {
                return 'success';
            }
            return '';
        }

        // å¤„ç†åˆ—è¡¨é¡¹ç‚¹å‡»
        function handleItemClick(itemData) {
            // åœæ­¢å®æ—¶æ›´æ–°
            TimerBusiness.stopRealTimeUpdate();
            
            const currentState = TimerBusiness.getCurrentState();
            
            // å¤„ç†è®¾ç½®é¡µé¢
            if (itemData.type === 'settings') {
                showSettingsPage();
                return;
            }
            
            // å¤„ç†ç­‰å¾…è¾“å…¥çŠ¶æ€
            if (itemData.type === 'message_input_waiting') {
                return;
            }
            
            // å¤„ç†å‡†å¤‡å¯åŠ¨
            if (itemData.type === 'ready_to_start') {
                if (itemData.timerData && (!itemData.message || itemData.message.trim() === '')) {
                    return;
                }
                
                TimerBusiness.setCurrentState('normal');
                TimerBusiness.setWaitingTimerData(null);
                
                if (itemData.timerData) {
                    TimerBusiness.handleTimerSelection(itemData.timerData, itemData.message || '');
                } else {
                    TimerBusiness.startTimer(itemData.duration, itemData.timerName, '');
                }
                
                // å…³é—­çª—å£
                if (typeof utools !== 'undefined') {
                    utools.hideMainWindow();
                    utools.outPlugin();
                }
                return;
            }
            
            // å¤„ç†å‡†å¤‡ä¿®æ”¹æ—¶é—´
            if (itemData.type === 'ready_to_modify' && itemData.taskData) {
                TimerBusiness.modifyTimerTaskTime(itemData.taskData.taskId, itemData.duration, (items) => {
                    renderList(items);
                });
                TimerBusiness.setCurrentState('normal');
                TimerBusiness.setWaitingTimerData(null);
                return;
            }
            
            // å¤„ç†è‡ªå®šä¹‰æ—¶é—´
            if (itemData.type === 'custom') {
                isInSubView = false; // ğŸ”¥ è¾“å…¥æ¨¡å¼ä¸ç®—å­è§†å›¾
                TimerBusiness.setCurrentState('custom_input');
                utools.setSubInputValue('');
                updateList('');
                return;
            }
            
            // å¤„ç†å†å²æŸ¥çœ‹
            if (itemData.type === 'history') {
                isInSubView = true; // ğŸ”¥ è¿›å…¥å­è§†å›¾
                TimerBusiness.showCurrentRunningTasks((items) => {
                    renderList(items);
                });
                return;
            }
            
            // å¤„ç†ä»»åŠ¡é¡¹é€‰æ‹©
            if (itemData.type === 'current_task_item' && itemData.taskData) {
                isInSubView = true; // ğŸ”¥ è¿›å…¥å­è§†å›¾
                const options = [{
                    title: t('setNewTime'),
                    description: '',
                    icon: './icons/edit_time.png',
                    type: 'modify_time',
                    taskData: itemData.taskData
                }, {
                    title: t('cancelTimer'),
                    description: '',
                    icon: './icons/cancel.png',
                    type: 'cancel_task',
                    taskData: itemData.taskData
                }, {
                    title: `â† ${t('backToTasks')}`,
                    description: t('backToTasksList'),
                    icon: './icons/back.png',
                    type: 'back_to_tasks'
                }];
                renderList(options);
                return;
            }
            
            // å¤„ç†ä¿®æ”¹æ—¶é—´æ“ä½œ
            if (itemData.type === 'modify_time' && itemData.taskData) {
                isInSubView = false; // ğŸ”¥ è¾“å…¥æ¨¡å¼ä¸ç®—å­è§†å›¾
                TimerBusiness.setCurrentState('modify_time');
                TimerBusiness.setWaitingTimerData(itemData.taskData);
                utools.setSubInputValue('');
                updateList('');
                return;
            }
            
            // å¤„ç†å–æ¶ˆä»»åŠ¡
            if (itemData.type === 'cancel_task' && itemData.taskData) {
                isInSubView = true; // ğŸ”¥ å–æ¶ˆåè¿˜åœ¨ä»»åŠ¡åˆ—è¡¨
                TimerBusiness.cancelTimerTask(itemData.taskData.taskId, (items) => {
                    renderList(items);
                });
                return;
            }
            
            // å¤„ç†è¿”å›ä»»åŠ¡åˆ—è¡¨
            if (itemData.type === 'back_to_tasks') {
                isInSubView = true; // ğŸ”¥ ä»åœ¨å­è§†å›¾
                TimerBusiness.showCurrentRunningTasks((items) => {
                    renderList(items);
                });
                return;
            }
            
            // å¤„ç†è¿”å›ä¸»èœå•
            if (itemData.type === 'back_to_main') {
                isInSubView = false; // ğŸ”¥ å›åˆ°ä¸»è§†å›¾
                TimerBusiness.setCurrentState('normal');
                utools.setSubInputValue('');
                updateList('');
                TimerBusiness.startRealTimeUpdate();
                return;
            }
            
            // é»˜è®¤å¤„ç†ï¼šè¿›å…¥æç¤ºä¿¡æ¯è¾“å…¥æ¨¡å¼
            isInSubView = false; // ğŸ”¥ è¾“å…¥æ¨¡å¼ä¸ç®—å­è§†å›¾
            TimerBusiness.setCurrentState('message_input');
            TimerBusiness.setWaitingTimerData(itemData);
            utools.setSubInputValue('');
            updateList('');
        }

        // å¤„ç†æœç´¢è¾“å…¥
        function handleSearch(searchTerm) {
            const currentState = TimerBusiness.getCurrentState();
            
            // å¦‚æœåœ¨æç¤ºä¿¡æ¯è¾“å…¥çŠ¶æ€
            if (currentState === 'message_input') {
                TimerBusiness.stopRealTimeUpdate();
                const waitingData = TimerBusiness.getWaitingTimerData();
                
                if (searchTerm && searchTerm.trim() !== '') {
                    renderList([{
                        title: `${waitingData.title}`,
                        description: `æç¤ºä¿¡æ¯: "${searchTerm}"ï¼ŒæŒ‰å›è½¦ç¡®è®¤`,
                        icon: waitingData.icon,
                        type: 'ready_to_start',
                        timerData: waitingData,
                        message: searchTerm
                    }]);
                } else {
                    renderList([{
                        title: `${waitingData.title}`,
                        description: 'è¯·è¾“å…¥æç¤ºä¿¡æ¯ï¼ˆå¿…å¡«ï¼‰',
                        icon: waitingData.icon,
                        type: 'message_input_waiting',
                        timerData: waitingData
                    }]);
                }
                return;
            }
            
            // å¦‚æœåœ¨æ—¶é—´ä¿®æ”¹è¾“å…¥çŠ¶æ€
            if (currentState === 'modify_time') {
                TimerBusiness.stopRealTimeUpdate();
                const timeInfo = TimerBusiness.parseTimeInput(searchTerm);
                
                if (timeInfo) {
                    renderList([{
                        title: `ä¿®æ”¹ä¸º ${timeInfo.displayText}`,
                        description: `å°†å®šæ—¶å™¨æ—¶é—´ä¿®æ”¹ä¸º ${timeInfo.displayText}ï¼ŒæŒ‰å›è½¦ç¡®è®¤`,
                        icon: './icons/edit.png',
                        type: 'ready_to_modify',
                        duration: timeInfo.duration,
                        taskData: TimerBusiness.getWaitingTimerData()
                    }]);
                } else {
                    renderList([{
                        title: 'ä¿®æ”¹æ—¶é—´',
                        description: 'è¯·è¾“å…¥æ­£ç¡®çš„æ—¶é—´æ ¼å¼ï¼ˆå¦‚ï¼š30åˆ†é’Ÿã€45ç§’ã€2å°æ—¶ï¼‰',
                        icon: './icons/edit.png',
                        type: 'modify_time_input_hint'
                    }]);
                }
                return;
            }
            
            // å¦‚æœåœ¨è‡ªå®šä¹‰æ—¶é—´è¾“å…¥çŠ¶æ€
            if (currentState === 'custom_input') {
                TimerBusiness.stopRealTimeUpdate();
                const timeInfo = TimerBusiness.parseTimeInput(searchTerm);
                
                if (timeInfo) {
                    renderList([{
                        title: `å®šæ—¶å™¨ ${timeInfo.displayText}`,
                        description: `å°†è®¾ç½® ${timeInfo.displayText} çš„å®šæ—¶å™¨ï¼ŒæŒ‰å›è½¦å¼€å§‹`,
                        icon: './icons/logo.png',
                        type: 'ready_to_start',
                        duration: timeInfo.duration,
                        timerName: `è‡ªå®šä¹‰å®šæ—¶å™¨ ${timeInfo.displayText}`
                    }]);
                } else {
                    renderList([{
                        title: 'è‡ªå®šä¹‰æ—¶é—´',
                        description: 'è¯·è¾“å…¥æ­£ç¡®çš„æ—¶é—´æ ¼å¼ï¼ˆå¦‚ï¼š30åˆ†é’Ÿã€45ç§’ã€2å°æ—¶ï¼‰',
                        icon: './icons/logo.png',
                        type: 'custom_input_hint'
                    }]);
                }
                return;
            }
            
            // æ­£å¸¸æœç´¢
            TimerBusiness.setCurrentState('normal');
            updateList(searchTerm);
            TimerBusiness.startRealTimeUpdate();
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è®¾ç½®å›è°ƒå‡½æ•°ä¾›ä¸šåŠ¡é€»è¾‘ä½¿ç”¨
        TimerBusiness.setCurrentCallbackSetList((items) => {
            renderList(items, true); // ğŸ”¥ åˆ·æ–°æ—¶ä¿æŒé€‰ä¸­çŠ¶æ€
        });

        // æ¯ç§’æ›´æ–°ä¸€æ¬¡åˆ—è¡¨ï¼ˆä¿æŒæ—¶é—´ä¿¡æ¯åŒæ­¥åˆ°ç§’ï¼‰
        setInterval(() => {
            const currentState = TimerBusiness.getCurrentState();
            // ğŸ”¥ åªæœ‰åœ¨ä¸»è§†å›¾ä¸”çŠ¶æ€ä¸º normal æ—¶æ‰åˆ·æ–°
            if (currentState === 'normal' && !isInSubView) {
                // æ›´æ–°æ—¶ä¿æŒé€‰ä¸­çŠ¶æ€
                const items = TimerBusiness.generateListItemsWithDynamicTime(currentSearchTerm);
                renderList(items, true);
            }
        }, 1000);

        // ğŸ”¥ é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®äº‹ä»¶ç›‘å¬
        window.addEventListener('DOMContentLoaded', () => {
            // ç›‘å¬é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', handleKeyDown);
            
            // ç›‘å¬é¼ æ ‡ç§»åŠ¨äº‹ä»¶ - åªæœ‰çœŸæ­£ç§»åŠ¨æ—¶æ‰å¯ç”¨é¼ æ ‡é€‰æ‹©
            const mouseMoveThreshold = 5; // é¼ æ ‡ç§»åŠ¨é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
            
            document.addEventListener('mousemove', (e) => {
                // å¦‚æœæ˜¯é¦–æ¬¡è®°å½•ï¼Œåªè®°å½•ä½ç½®ä¸å¯ç”¨é¼ æ ‡
                if (lastMouseX === null || lastMouseY === null) {
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    return;
                }
                
                // è®¡ç®—é¼ æ ‡ç§»åŠ¨è·ç¦»
                const deltaX = Math.abs(e.clientX - lastMouseX);
                const deltaY = Math.abs(e.clientY - lastMouseY);
                
                // åªæœ‰å½“é¼ æ ‡çœŸæ­£ç§»åŠ¨è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‰å¯ç”¨é¼ æ ‡é€‰æ‹©
                if (deltaX > mouseMoveThreshold || deltaY > mouseMoveThreshold) {
                    isUsingKeyboard = false;
                    document.body.classList.remove('keyboard-nav');
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                }
            });
            
            // ç›‘å¬è®¾ç½®é¡µé¢è¿”å›æŒ‰é’®
            settingsBack.addEventListener('click', () => {
                hideSettingsPage();
            });
            
            // ç›‘å¬æ’ä»¶è¿›å…¥äº‹ä»¶ - æ¯æ¬¡è¿›å…¥æ—¶éƒ½é‡æ–°åˆå§‹åŒ–
            window.utools.onPluginEnter(({ code, type, payload }) => {
                initialize();
            });
        });
    </script>
</body>
</html>

